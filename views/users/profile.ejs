<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My-Profile</title>
    <!-- <link rel="stylesheet" href="/user/css/profile.css" /> -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>

      is-valid {
        border: 1px solid green;
      }

      is-invalid {    
        border: 1px solid red;
      }
      input {
    padding:5px;
}
input.error {
    border:1px solid #99182c;
}
span.arrow {
    height:17px;
    background: url('http://i45.tinypic.com/f9ifz6.png') no-repeat center left;
    top:4px;
}
label.error {
    border-top:1px solid #99182c;
    border-bottom:1px solid #99182c;
    border-right:1px solid #99182c;    
    color:black;
    padding:1px 5px 1px 5px;
    font-size:small;

}
    </style>
  </head>

  <body>
    <% if (name) { %> <%- include('files/navbar.ejs', {name}) %> <% } else { %>
      <%- include('files/navbar.ejs', {name:""}) %> <% } %>
    <section class="bg-light">
      <div class="container">
        <h3 class="text-center py-2">My profile</h3>
        <div class="row">
          <div class="col-lg-3 col-xl-3">
            <nav class="nav flex-lg-column w-100 d-flex nav-pills mb-4">
              <a class="nav-link my-0 active" href="#"
                ><p class="pb-0 mb-0" style="width: 100px">Account main</p></a
              >
              <a class="nav-link my-0 bg-light" href="/profile/orderhistory"
                ><p class="pb-0 mb-0" style="width: 100px">Orders history</p></a
              >
              <!-- chgpass -->
              <a class="nav-link my-0 bg-light" href="/profile/chgpass"
                ><p class="pb-0 mb-0" style="width: 100px">Change Password</p></a
              >
              <a class="nav-link my-0 bg-light" href="/profile/wishlist"
              ><p class="pb-0 mb-0" style="width: 100px">My Wishlist</p></a
            >
            <a class="nav-link my-0 bg-light" href="/profile/wallet"
                ><p class="pb-0 mb-0" style="width: 100px">My Wallet</p></a
              >
            </nav>
          </div>
          <main class="col-lg-9 col-xl-9">
            <div class="card p-4 mb-0 shadow-0 border">
              <div class="content-body">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <img
                      src="https://media.licdn.com/dms/image/C5603AQFSg4R-IWdHpg/profile-displayphoto-shrink_200_200/0/1652343116317?e=1713398400&v=beta&t=pId84GVug1OrDmLQlVhqEfuBRnRisStJoqqM4qmCgrc"
                      class="rounded-circle"
                      style="height: 60px; width: 60px"
                    />
                  </div>
                  <div class="pt-2">
                    <% if(userData){%> <% userData.forEach(function(user){ %>
                    <h6 class="pt-1">Name : <%= user.name%></h6>

                    <p>
                      Email : <%= user.email %>, Mobile No: <%= user.mobile %>,
                      <a href="#" class="px-2"></a>
                    </p>
                    <% }); %> <% } %>
                  </div>
                </div>

                <hr />
                <!-- Button trigger modal -->
                <p class="d-inline-flex gap-1">
                  <button
                    class="btn btn-primary btn-filter-expand"
                    data-bs-toggle="collapse"
                    href="#collapseExample"
                    role="button"
                    aria-expanded="false"
                    aria-controls="collapseExample"
                  >
                    Add New Address
                  </button>
                </p>
                <div class="collapse" id="collapseExample">
                  <div class="card card-body">
                    <h5 class="modal-title text-center mb-3" id="exampleModalLabel">
                      Add New Address
                    </h5>
                    <form
                      name="addAddressForm"
                      method="POST"
                      role="form"
                      id="addAddressForm"
                    >
                      <div class="modal-body">
                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="addressTitle"
                            name="addressTitle"
                            class="form-control"
                            placeholder="Address Title"
                            
                          />                        
                        </div>
                        
                        <div class="text-danger mb-3" id="addressTitle-error"></div>                        
                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="firstName"
                            name="firstName"
                            class="form-control"
                            placeholder="First Name"
                            
                          />
                          
                        </div>
                        <div class="text-danger mb-3" id="firstName-error"></div>

                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="lastName"
                            name="lastName"
                            class="form-control"
                            placeholder="Last Name"
                            
                          />
                        </div>
                        <div class="text-danger mb2" id="lastName-error"></div>
                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="addressLine1"
                            name="addressLine1"
                            class="form-control"
                            placeholder="Address Line 1"
                            
                          />
                        </div>
                        <div class="text-danger mb-3" id="addressLine1-error"></div>
                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="addressLine2"
                            name="addressLine2"
                            class="form-control"
                            placeholder="Address Line 2"
                          />
                        </div>
                        <div class="text-danger mb-3" id="addressLine2-error"></div>
                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="state"
                            name="state"
                            class="form-control"
                            placeholder="State"
                            
                          />
                        </div>
                        <div class="text-danger mb-3" id="state-error"></div>
                        <div class="input-group mb-3">
                          <input
                            type="text"
                            id="phone"
                            name="phone"                           
                            class="form-control"
                            placeholder="Phone Number"
                            
                          />
                        </div>
                        <div class="text-danger mb-3" id="phone-error"></div>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">
                          Add Address
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
                <div class="row g-2 mb-3" id="addressDetails">
                  <% if (addressData) { addressData.forEach(function(address){
                  %>

                  <div class="col-lg-5 mx-3">
                    <h6><%= address.addressTitle %></h6>
                    <div
                      class="border d-flex justify-content-between align-items-center rounded-3 bg-light"
                    >
                      <div class="d-flex align-items-center p-2 me-3">
                        <%= address.firstName %> <%= address.lastName %> <br />
                        <%= address.addressLine1 %><br />
                        <%= address.addressLine1 %><br />
                        <%= address.phone %>
                      </div>
                      <div>
                        <button
                          class="btn text-primary me-2"
                          id="address"
                          // onclick="getAdress('<%= address._id %>')"
                          data-bs-toggle="modal"
                          data-bs-target="#exampleModal1"
                          data-bs-whatever="<%= address._id %>"
                        >
                          <i class="fa fa-pen"></i>                          
                        </button>
                        <button
                          class="btn text-primary me-2"
                          id="deladdress"
                          onclick="deltAdress('<%= address._id %>')"
                          
                          
                        >
                          <i class="fa fa-trash"></i>                          
                        </button>
                      </div>
                    </div>
                  </div>

                  <% }) } %>
                </div>

                <hr class="my-4" />
              </div>
            </div>
          </main>
        </div>
      </div>
    </section>
    <% if (addressData) {
    addressData.forEach(function(address){ %>

    <div
      class="modal fade"
      id="exampleModal1"
      tabindex="-1"
      aria-labelledby="exampleModalLabel1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel1">Edit Address </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="editAddressForm" method="POST" role="form">
            <div class="modal-body">
              
              <input type="hidden" name="id" value="" id="id">
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="firstName"
                  name="firstName"
                  class="form-control"
                  value=""
                  
                />
              </div>

              <div class="input-group mb-3">
                <input
                  type="text"
                  id="lastName"
                  name="lastName"
                  class="form-control"
                  value=""
                  
                />
              </div>
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="addressLine1"
                  name="addressLine1"
                  class="form-control"
                  value=""
                  
                />
              </div>
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="addressLine2"
                  name="addressLine2"
                  class="form-control"
                  value=""
                />
              </div>

              <div class="input-group mb-3">
                <input
                  type="text"
                  id="state"
                  name="state"
                  class="form-control"
                  value=""
                  
                />
              </div>
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="phone"
                  name="phone"                  
                  class="form-control"                  
                  
                />
              </div>
              
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">
                Edit Address
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <% }) }%>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    
  <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

  
    <script>


      /**/
const exampleModal = document.getElementById('exampleModal1')
if (exampleModal) {
  exampleModal.addEventListener('show.bs.modal', async event => {
    // Button that triggered the modal
    const button = event.relatedTarget
    // Extract info from data-bs-* attributes
    const id = button.getAttribute('data-bs-whatever')

    let address = await getAdress(id)

    if(!address){
      Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "Something went wrong!"
              
            });
    } else{

        
    //title
    const title = exampleModal.querySelector('.modal-title')
     title.textContent = `Edit ${address.addressTitle} Address`;
    
     const id = exampleModal.querySelector('#id')
    id.value = address._id;


     //first name
    const firstName = exampleModal.querySelector('#firstName')
    firstName.value = address.firstName;

    //last name
    const lastName = exampleModal.querySelector('#lastName')
    lastName.value = address.lastName;

    const addressLine1 = exampleModal.querySelector('#addressLine1')
    addressLine1.value = address.addressLine1;

    const addressLine2 = exampleModal.querySelector('#addressLine2')
    addressLine2.value = address.addressLine2;

    const state = exampleModal.querySelector('#state')
    state.value = address.state;

    const phone = exampleModal.querySelector('#phone')
    phone.value = address.phone;

    }//else end bracket
    // addressTitle

    // If necessary, you could initiate an Ajax request here
    // and then do the updating in a callback.


  });
}

      $("button.btn-filter-expand").html("Add New Address");
      $("button.btn-filter-expand").click(function () {
        if ($(this).html() == "Add New Address") {
          $(this).html("Hide New Address");
        } else {
          $(this).html("Add New Address");
        }
      });

      async function getAdress(id) {
        let response = await fetch("/profile/getaddress/" + id, {
          method: "GET",
        });
        let data = await response.json();
        return data.data[0];
      }

      async function deltAdress(id) {
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!",
        }).then((result) => {
          if (result.isConfirmed) {
            // making request to delete with id
            $.ajax({
              url: "/profile/deladdress/" + id,
              method: "GET",        
              success: function (response) {
                // Handle success response      

                if(response.success==true){
                  
                  $("#addressDetails").empty();
                  $("#addressDetails").load(location.href + " #addressDetails>*", "");
                  Swal.fire({
                  title: "Address Delete",
                  text: "Address Deleted Succesfully",
                  icon: "success"
                  });

                  }else{
                  Swal.fire({
                  icon: "error",
                  title: "Oops...",
                  text: "Something went wrong!"

                  });
                  
                }
              }
              });
          }
        });
      }

    function checkPhone(frmData){
      let pattern = /[0-9]{10}/ig;

const tagId = ("#"+frmData.id).toString()
const disp = frmData.id+"-error"


  if (pattern.test(frmData.value)) {      
    
    $(tagId).removeClass("is-invalid");
    $(tagId).addClass("is-valid");  
    document.getElementById(disp).innerText ="";
    return true
  }else{          
    $(tagId).addClass("is-invalid");
    document.getElementById(disp).innerText = "This field is required";
  return false
  }
  }
      

      function checkValue(frmData){
        let pattern = /[a-z]/ig;

        const tagId = ("#"+frmData.id).toString()
        const disp = frmData.id+"-error"
        
       
        if (pattern.test(frmData.value)) {      
          
          $(tagId).removeClass("is-invalid");
          $(tagId).addClass("is-valid");  
          document.getElementById(disp).innerText ="";
          return true
        }else{          
          $(tagId).addClass("is-invalid");
          document.getElementById(disp).innerText = "This field is required";
         return false
        }
      }
     
      function whiteSpace(data) {
        let result = false;
        for(let i=0;i<data.length-2;i++ ){
          result =  checkValue(data[i]);
        }
        result = checkPhone(data[6])
        
        return result
      }
      // Handle form submission
      $(document).on("submit", "#addAddressForm", function (e) {
        e.preventDefault(); // Prevent the form from submitting normally
        const form = document.getElementById("addAddressForm");

        // Gather form data
        const formData = $(this).serialize();
        
        if(whiteSpace(form)){
          // AJAX request to submit form data to the server
        $.ajax({
          url: "/profile/addAddress",
          method: "POST",
          data: formData,
          success: function (response) {
            // Handle success response            
            if(response.success==true){
              Swal.fire({
                title: "Address Added",
                text: "Address Added Succesfully",
                icon: "success",
              });
              $("#addAddressForm")[0].reset();

              $("button.btn-filter-expand").click();
              $("#addressDetails").empty();
              $("#addressDetails").load(location.href + " #addressDetails>*", "");
          }
          },
          error: function (xhr, status, error) {
            // Handle error response
            console.error(error);
          },
        });
        }
        
      });

      //edit form update values in back end

       $(document).on("submit", "#editAddressForm", function (e) {
        e.preventDefault(); // Prevent the form from submitting normally

        // Gather form data
        const formData = $(this).serialize();
 

        // AJAX request to submit form data to the server
        $.ajax({
          url: "/profile/editAddress",
          method: "POST",
          data: formData,
          success: function (response) {
            // Handle success response
            if(response.success==true){
                Swal.fire({
                  title: "Address Update",
                  text: "Address Updated Succesfully",
                  icon: "success",
                });
                $("button.btn-close").click();
                // $("#addressDetails").load("#addressDetails");
                $("#addressDetails").empty();
                $("#addressDetails").load(location.href + " #addressDetails>*", "");
            }
            
            // $("#editAddressForm")[0].reset();
            // $("button.btn-filter-expand").click();
          },
          error: function (xhr, status, error) {
            // Handle error response
            console.error(error);
          },
        });
      
      });

    </script>

    <script>
      async function cancelOrder(orderId) {
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, Cancel the order",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("/cancelOrder/" + orderId, { method: "PUT" }).then((d) =>
              console.log(d)
            );
            /*let cancelBtnElement = document.getElementById('cancelBtn')
                    let cancelledBtnElement = document.getElementById('597a5bdf082df5a383c94b')

                    cancelBtnElement.style.display = 'none'
                    cancelledBtnElement.style.display = 'block'*/
            Swal.fire({
              title: "Cancelled!",
              text: "Your order has been cancelled.",
              icon: "success",
            });
          }
        });
      }
    </script>

    <script>
      let copyReferralCode = document.getElementById("copyReferralCode");
      let copyText = document.getElementById("copyText");
      copyReferralCode.addEventListener("click", () => {
        // Select the text field
        copyText.select();
        copyText.setSelectionRange(0, 99999); //For mobile devices

        // Copy the text inside the text field
        navigator.clipboard.writeText(copyText.value);

        Swal.fire("Copied your referral code");
      });
    </script>
  </body>
</html>
